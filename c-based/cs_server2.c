#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>

/* Simple server.  Connect to it, and it prints a message then closes.
 * Same as cs_server.c, but much cleaner implementation.
 * johnny live dangerously; removing all the error-checking kerfluffle */

int main(int argc, char *argv[]){
   if(argc < 4){
     printf("USAGE: %s %s %s %s\n", 
           argv[0], "[bind IP]", "[Listen port]", "[CX response to send]");
     exit(0);
   }
   int fd, cx_fd;
   socklen_t s_size;
   int y=1;
   struct sockaddr_in h_addr = {
      AF_INET, // family
      htons(atoi(argv[2])),  // port
      inet_addr(argv[1]), // ip
      "00000000" // char sin_zero[8]
   }, c_addr;
     
   fd = socket(PF_INET, SOCK_STREAM, 0);
   setsockopt(fd, SOL_SOCKET, SO_REUSEADDR, &y, sizeof(int));
   bind(fd, (struct sockaddr *)&h_addr, sizeof(struct sockaddr)); 
   listen(fd, 5);

   while (1) {
      s_size = sizeof(struct sockaddr_in);
      cx_fd = accept(fd, (struct sockaddr *)&c_addr, &s_size);
      printf("Server: Inbound CX From: %s:%d\n",
          inet_ntoa(c_addr.sin_addr), ntohs(c_addr.sin_port));
      send(cx_fd, argv[3], strlen(argv[3]), 0);
      send(cx_fd, "\n", 1, 0);
      close(cx_fd); 
   }
   return(0);
}


