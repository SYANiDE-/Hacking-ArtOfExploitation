#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include "sylib.h"

#define BUFMAX 1024

int main(int argc, char *argv[]){
   if(argc < 3){
      printf("USAGE: %s %s %s\n", argv[0], "[ip]", "[port]");
      exit(0);
   }
   int fd, recv_len=0, i;
   socklen_t addr_len;
   char buf[BUFMAX], r_buf[BUFMAX],
        *c_stop = "client(stop)", 
        *s_stop = "server(stop)",
        *c_msg = "[!] Stop client with \"client(stop)\"",
        *c_quitting = "[!] Client quitting...";
   memset(&buf, '\x00', BUFMAX);
   struct sockaddr_in c_addr = {
      AF_INET,
      htons(atoi(argv[2])),
      inet_addr(argv[1]),
      "00000000"
   };

   fd = socket(PF_INET, SOCK_STREAM, 0);
   if(connect(fd, (struct sockaddr *)&c_addr, sizeof(struct sockaddr)) == -1){
      snprintf(buf, sizeof buf, 
          "Couldn't CX  to %s:%s !", argv[1], argv[2]);
      fe(buf); 
   }else{
      printf("%s\n", c_msg);
      recv_len = recv(fd, &buf, BUFMAX, 0);
      if(recv_len > 0){
         for(i=0; i<recv_len; i++){
            printf("%c", buf[i]);
         }
         printf("\n");
      }
   }
   while(1){
      memset(&buf, '\x00', BUFMAX);
      fgets(buf, BUFMAX, stdin);
      send(fd, &buf, strlen(buf),0);
      if((strncmp(c_stop, buf, 12) == 0) || (strncmp(s_stop, buf, 12) == 0)){
         printf("%s\n", c_quitting);
         exit(0);
      }
   }
   return(0);
}
